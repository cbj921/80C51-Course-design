C51 COMPILER V9.01   MAIN                                                                  01/04/2020 13:33:59 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg52.h>
   2          #include "delay.h"
   3          #include "buzzer.h"
   4          #include "digitalTube.h"
   5          #include "timer.h"
   6          #include "key.h"
   7          #include "led.h"
   8          #include "uart.h"
   9          // 注意事项，使用串口时一定要勾选 “发送新行” 否则出错；设置闹钟要将 “请于” 删除，直接以年份开头
  10          unsigned int test=0;
  11          
  12          unsigned char monthDay[] = {31,28,31,30,31,30,31,31,30,31,30,31}; // 二月暂时按平年算
  13          unsigned char getData;
  14          unsigned char sdat[64]={0x00};        // 数据缓存区
  15          unsigned char sendDat[8]={0x00};     // 发送数据缓冲区
  16          unsigned char sendIndex = 0;         // 发送缓冲区指针
  17          unsigned char sp=0;   // 数据缓存区指针
  18          
  19          unsigned char keyFlag=0;
  20          unsigned char countSecond = 0; // 用来计数3秒
  21          unsigned char ledTime = 0;
  22          
  23          // 通过中断来更新以下数据
  24          unsigned char hour=0,minute=0,second=0,month=1,day=21,week = 0;
  25          unsigned int year=2020; 
  26          unsigned char T0Num = 0;
  27          unsigned char modeFlag = 0; // 0：显示分秒 1：显示公元年  2：显示月日
  28          
  29          void updateTimeData();
  30          void showTime_MS();
  31          void showTime_Year();
  32          void stayThreeSecond();
  33          void showTime_MonthDay();
  34          void showWeekLed();
  35          unsigned char getWeek(unsigned int tYear,unsigned char tMonth,unsigned char tDay);
  36          void dealData(unsigned char *dataGo);
  37          unsigned char getTimeFromData(unsigned char *dataGo);
  38          void clearSDAT();
  39          unsigned char judgeLeapOrOrdinaryYear(unsigned int tYear);
  40          unsigned char getMonthDay(unsigned char tYear,unsigned char tMonth);
  41          unsigned char getSDATLength(unsigned char *point);
  42          void analyChar(unsigned char *point,unsigned char length);
  43          unsigned int getYearFromQuestion(unsigned char *point);
  44          void sendData(unsigned char *point);
  45          unsigned char getMonthFromQuestion(unsigned char *point);
  46          unsigned char getWorkDayFromMonth(unsigned int yearGo,unsigned char monthGo);
  47          
  48          int main()
  49          {
  50   1              // init，各项功能初始化
  51   1              timerInit_0();           // 初始化计时器0
  52   1              uart_init();             // 初始化串口
  53   1              week = getWeek(year,month,day);          // 初始化星期
  54   1              showWeekLed();           // 显示LED
  55   1              clearSDAT();             // 清空缓冲区
C51 COMPILER V9.01   MAIN                                                                  01/04/2020 13:33:59 PAGE 2   

  56   1              ///////////////////////
  57   1              while(1)
  58   1              {       
  59   2                      updateTimeData();   // 更新时间数据
  60   2                      modeFlag = checkKey_s1(&keyFlag,modeFlag); // 检测按键 S1
  61   2                      modeFlag = checkKey_s2(&keyFlag,modeFlag); // 检测按键 S2
  62   2                      switch(modeFlag){
  63   3                              case 0: showTime_MS(); break;
  64   3                              case 1: showTime_Year(); break;
  65   3                              case 2: showTime_MonthDay(); break;
  66   3                      }       
  67   2              }
  68   1              return 0;
  69   1      }
  70          
  71          // 定时器T0中断函数
  72          void T0_func(void) interrupt 1
  73          {
  74   1              // T0为50ms溢出一次
  75   1              // 重装计数器
  76   1              TH0 = 0x3c;                                     //装定时初值高8位
  77   1              TL0 = 0xb0;                                     //装定时初值低8位
  78   1              T0Num++;
  79   1              if(T0Num == 20)
  80   1              {
  81   2                      T0Num = 0;
  82   2                      second++;
  83   2                      showWeekLed();             // 让LED灯显示并循环
  84   2              }
  85   1              stayThreeSecond();             // 三秒计数器    
  86   1      }
  87          // 更新时间数据
  88          void updateTimeData()
  89          {
  90   1              if(second >=60)
  91   1              {
  92   2                      second = 0;
  93   2                      minute ++;
  94   2              }
  95   1              if(minute >= 60)
  96   1              {
  97   2                      minute = 0;
  98   2                      hour ++;
  99   2              }
 100   1              if(hour >= 24)
 101   1              {
 102   2                      hour = 0;
 103   2                      day++;
 104   2                      week = getWeek(year,month,day);          //更新星期
 105   2              }
 106   1              if(day > getMonthDay(year,month))
 107   1              {
 108   2                      day = 1;
 109   2                      month++;        
 110   2              }
 111   1              if(month > 12)
 112   1              {
 113   2                      month = 1;
 114   2                      year++;
 115   2              }
 116   1      }
 117          // 显示分秒的函数
C51 COMPILER V9.01   MAIN                                                                  01/04/2020 13:33:59 PAGE 3   

 118          void showTime_MS()
 119          {
 120   1              unsigned char m1,m2,s1,s2;
 121   1              m2 = minute %10; // 分钟个位
 122   1              m1 = minute /10; // 分钟十位
 123   1              s2 = second %10; // 秒个位
 124   1              s1 = second /10; //     秒十位
 125   1              showFourNum(m1,m2,s1,s2,1);
 126   1      }
 127          // 显示公元年
 128          void showTime_Year()
 129          {
 130   1              unsigned char y1,y2,y3,y4;
 131   1              unsigned int tempYear = year;
 132   1              y4 = tempYear %10;
 133   1              tempYear = tempYear/10;
 134   1              y3 = tempYear %10;
 135   1              tempYear = tempYear/10;
 136   1              y2 = tempYear %10;
 137   1              tempYear = tempYear/10;
 138   1              y1 = tempYear %10;
 139   1              showFourNum(y1,y2,y3,y4,0);
 140   1      }
 141          // 显示月日
 142          void showTime_MonthDay()
 143          {
 144   1              unsigned char m1,m2,d1,d2;
 145   1              m2 = month %10;
 146   1              m1 = month /10;
 147   1              d2 = day %10;
 148   1              d1 = day /10;
 149   1              showFourNum(m1,m2,d1,d2,1);     
 150   1      }
 151          // 显示三秒的等待函数
 152          void stayThreeSecond()
 153          {
 154   1              if(keyFlag == 1)
 155   1              {
 156   2                      countSecond ++;
 157   2                      if(countSecond == 60)
 158   2                      {
 159   3                              keyFlag = 0;
 160   3                              modeFlag = 0;
 161   3                              countSecond = 0;
 162   3                      }
 163   2              }
 164   1      }
 165          // 计算星期函数
 166          unsigned char getWeek(unsigned int tYear,unsigned char tMonth,unsigned char tDay)
 167          {
 168   1              unsigned char topTwoYear ;              // 年份前两位(默认年份四位数)
 169   1              unsigned char lastTwoYear ;             // 年份后两位
 170   1              unsigned char dayGo = tDay;                             // 日
 171   1              unsigned char monthGo = tMonth;             // 3<=monthGo<=14,即1，2月当作前年的13，14月
 172   1              unsigned char weekGo;
 173   1      
 174   1              if(monthGo<3)
 175   1              {
 176   2                      if(monthGo == 1) monthGo = 13;
 177   2                      else if(monthGo == 2) monthGo = 14;
 178   2                      tYear --; 
 179   2              }
C51 COMPILER V9.01   MAIN                                                                  01/04/2020 13:33:59 PAGE 4   

 180   1              topTwoYear = tYear/100;
 181   1              lastTwoYear = tYear%100;
 182   1              weekGo = ((topTwoYear/4)-2*topTwoYear+lastTwoYear+(lastTwoYear/4)+((13*(monthGo+1))/5)+dayGo-1)%7;
 183   1              return weekGo;
 184   1      }
 185          // led显示函数和蜂鸣器鸣叫
 186          void showWeekLed()
 187          {
 188   1              if(week !=0)
 189   1              {
 190   2                      week = getWeek(year,month,day);
 191   2                      showLed(week,ledTime%8);
 192   2                      ledTime++;      
 193   2              }
 194   1              else
 195   1              {
 196   2                      clearAllLed();
 197   2                      buzzer_reverse();       // 太吵了暂时注释
 198   2              }
 199   1      }
 200          
 201          // 串口中断函数
 202          void uart_func(void) interrupt 4
 203          {
 204   1              unsigned char length;
 205   1              // 接收数据
 206   1              if(RI)
 207   1              {
 208   2                      // 一个数字或者英文字符 占用 一个字节
 209   2                      // 一个汉字占用     两个字节
 210   2                      RI = 0;
 211   2                      getData = SBUF;
 212   2                      sdat[sp] = getData;
 213   2                      sp++;
 214   2                      if(sp>=32) sp = 0;
 215   2                      if(getData == 0x0A)
 216   2                      {
 217   3                              // 0x0A为结束标志位
 218   3                              // 通过判断数组中有效长度来判断是校准还是答题模式
 219   3                              length = getSDATLength(sdat);
 220   3                              if(length == 19)
 221   3                              {
 222   4                                      // 进行数据处理，赋值为对应的变量
 223   4                                      dealData(sdat); 
 224   4                              }  
 225   3                              else
 226   3                              {
 227   4                                      // 进行字符分析，给出答案
 228   4                                      analyChar(sdat,length);
 229   4                                      sendData(sendDat);      
 230   4                              } 
 231   3                              // 清空sdat缓冲区，sp清零
 232   3                              clearSDAT();
 233   3                              sp = 0;
 234   3                      }
 235   2                      //SBUF = getData;
 236   2                      //test
 237   2              }
 238   1              if(TI)
 239   1              {
 240   2                      TI =0;
 241   2              }
C51 COMPILER V9.01   MAIN                                                                  01/04/2020 13:33:59 PAGE 5   

 242   1      }
 243          // 处理接收来的数据
 244          void dealData(unsigned char *dataGo)
 245          {
 246   1              unsigned char timeFlag = 0;  // 处理时间的标志位，0：年，1：月，2：日，以此类推
 247   1              unsigned char temp=0,i;
 248   1              // 将原时间数据都清零
 249   1              year = 0,month = 0,day = 0,hour = 0,minute = 0,second = 0;
 250   1      
 251   1              while(*dataGo != 0x0D)
 252   1              {
 253   2                      // 处理日期数据
 254   2                      if(*dataGo == 0x2F || *dataGo == 0x3A ||*dataGo == 0x2D) // 因为斜杆和冒号的十六进制为 0x2f和0x3a
 255   2                      {
 256   3                              timeFlag++;     
 257   3                              dataGo++;
 258   3                      }
 259   2                      switch(timeFlag){
 260   3                              case 0:
 261   3                                      for(i=0;i<4;i++)
 262   3                                      {
 263   4                                              temp = *dataGo - 0x30;
 264   4                                              year *= 10;
 265   4                                              year += temp;
 266   4                                              dataGo++; 
 267   4                                      }
 268   3                                      break;
 269   3                              case 1:
 270   3                                      month = getTimeFromData(dataGo); // 因为参数只是传值，不会改变真正的datago地址
 271   3                                      dataGo += 2;                                     // 所以我们要在函数外面再自增 2 才行
 272   3                                      break;
 273   3                              case 2:
 274   3                                      day = getTimeFromData(dataGo);
 275   3                                      dataGo += 2;
 276   3                                      break;
 277   3                              case 3:
 278   3                                      hour = getTimeFromData(dataGo);
 279   3                                      dataGo += 2;
 280   3                                      break;
 281   3                              case 4:
 282   3                                      minute = getTimeFromData(dataGo);
 283   3                                      dataGo += 2;
 284   3                                      break;
 285   3                              case 5:
 286   3                                      second = getTimeFromData(dataGo);
 287   3                                      dataGo += 2;
 288   3                                      break;
 289   3                      }       
 290   2              }                               
 291   1      }
 292          // 计算月日时分秒的函数
 293          unsigned char getTimeFromData(unsigned char *point)
 294          {
 295   1              unsigned char temp=0,i;
 296   1              unsigned char returnValue=0;
 297   1              for(i=0;i<2;i++)
 298   1              {
 299   2                      temp = *point - 0x30;
 300   2                      returnValue *= 10;
 301   2                      returnValue += temp;
 302   2                      point++;
 303   2              }
C51 COMPILER V9.01   MAIN                                                                  01/04/2020 13:33:59 PAGE 6   

 304   1              return returnValue; 
 305   1      }
 306          // 清空缓冲区
 307          void clearSDAT()
 308          {
 309   1              unsigned char i;
 310   1              for(i=0;i<64;i++)
 311   1              {
 312   2                      sdat[i] = 0x00;
 313   2              }
 314   1      }
 315          // 判断平润年
 316          unsigned char judgeLeapOrOrdinaryYear(unsigned int tYear)
 317          {
 318   1              unsigned int tempYear = tYear;
 319   1              if((tempYear%4 == 0 && tempYear%100 !=0)||(tempYear%100 == 0 && tempYear%400==0))
 320   1              {
 321   2                      return 1;       
 322   2              }
 323   1              return 0;
 324   1      }
 325          // 得到相应月份有几天
 326          unsigned char getMonthDay(unsigned char tYear,unsigned char tMonth)
 327          {
 328   1              if(tMonth == 2)
 329   1              {
 330   2                      if(judgeLeapOrOrdinaryYear(tYear))
 331   2                      {
 332   3                              return 29;
 333   3                      }
 334   2              }
 335   1              return monthDay[tMonth-1];              
 336   1      }
 337          // 获得SDAT中有效数据长度
 338          unsigned char getSDATLength(unsigned char *point)
 339          {
 340   1              unsigned char i=0;
 341   1              for(i=0;*point != 0x0D;)
 342   1              {
 343   2                      i++;
 344   2                      point++;        
 345   2              }
 346   1              return i;
 347   1      }
 348          // 字符分析
 349          void analyChar(unsigned char *point,unsigned char length)
 350          {
 351   1              unsigned int tempYear=0;
 352   1              unsigned char tempMonth=0,tempDay=0,tempWeek=0;
 353   1      
 354   1              tempYear = getYearFromQuestion(point); // 获得年份
 355   1              if(length == 16)
 356   1              {
 357   2                      // 回答是否为闰年
 358   2                      if(judgeLeapOrOrdinaryYear(tempYear))
 359   2                      {
 360   3                              sendDat[0] = 0xCA;
 361   3                              sendDat[1] = 0xC7;
 362   3                      }
 363   2                      else
 364   2                      {
 365   3                              sendDat[0] = 0xB7;
C51 COMPILER V9.01   MAIN                                                                  01/04/2020 13:33:59 PAGE 7   

 366   3                              sendDat[1] = 0xF1;
 367   3                      }
 368   2                      sendDat[2] = 0x3A; // 0x3A为结束标志位
 369   2              }
 370   1              else if(length == 24)
 371   1              {
 372   2                      // 回答是星期几
 373   2                      tempMonth = getTimeFromData(&point[6]); // 获得月份
 374   2                      tempDay = getTimeFromData(&point[10]); // 获得日
 375   2                      tempWeek = getWeek(tempYear,tempMonth,tempDay);
 376   2                      sendDat[0] = tempWeek + 0x30;
 377   2                      sendDat[1] = 0x3A; // 0x3A为结束标志位          
 378   2              }
 379   1              else if(length == 22)
 380   1              {
 381   2                      // 该问题少一个问号，为回答有几个工作日
 382   2                      tempMonth = getTimeFromData(&point[6]); // 获得月份
 383   2                      tempDay   = getWorkDayFromMonth(tempYear,tempMonth); // 这里用tempDay作为工作日的变量
 384   2                      sendDat[0] = (tempDay /10) +0x30;
 385   2                      sendDat[1] = (tempDay %10) +0x30;
 386   2                      sendDat[2] = 0x3A;  // 0x3A为结束标志位 
 387   2              }       
 388   1      }
 389          // 从问题中获得年份
 390          unsigned int getYearFromQuestion(unsigned char *point)
 391          {
 392   1              // 因为年份就是前4位
 393   1              unsigned char i=0,temp=0;
 394   1              unsigned int yearGo=0;
 395   1              while(i<4)
 396   1              {
 397   2                      temp = *point - 0x30;
 398   2                      yearGo *= 10;
 399   2                      yearGo += temp;
 400   2                      i++;
 401   2                      point++;                        
 402   2              }
 403   1              return yearGo;  
 404   1      }
 405          // 发送发送缓冲区的内容
 406          void sendData(unsigned char *point)
 407          {
 408   1              unsigned char i;
 409   1              unsigned char *temp;
 410   1              // 因为发送缓冲区的数据是以 0x3A 来作为截止
 411   1              while(*point != 0x3A)
 412   1              {
 413   2                      SBUF = *point;
 414   2                      while(!TI);   // 当正在发送的时候等待 ,TI == 1 表示发送完成
 415   2                      point++;
 416   2              }
 417   1              // 清除发送缓冲区
 418   1              for(i=0;i<8;i++)
 419   1              {
 420   2                      temp[i] = 0x00;
 421   2              }               
 422   1      }
 423          // 从月份中获得工作日有几天
 424          unsigned char getWorkDayFromMonth(unsigned int yearGo,unsigned char monthGo)
 425          {
 426   1              // 注意年份都应该用 int 型，否则会溢出
 427   1              unsigned char tempWeek=0,tempDay=0;
C51 COMPILER V9.01   MAIN                                                                  01/04/2020 13:33:59 PAGE 8   

 428   1              char workDay = 0;
 429   1              // 先获取该月的 1日是星期几
 430   1              tempWeek = getWeek(yearGo,monthGo,1);
 431   1              if(tempWeek == 0) tempWeek = 7;
 432   1              // 再获取该月一共有几天
 433   1              tempDay =  getMonthDay(yearGo,monthGo);
 434   1              // 计算工作日
 435   1              workDay += (6-tempWeek);
 436   1              if(workDay == -1) workDay = 0;
 437   1              // 计算剩余的天数
 438   1              tempDay -= (8 - tempWeek);
 439   1              // 计算剩余天数中的工作日
 440   1              workDay += (tempDay/7)*5; 
 441   1              tempDay = tempDay %7;
 442   1              if(tempDay >5) tempDay = 5;
 443   1              workDay += tempDay;
 444   1      
 445   1              return workDay;
 446   1      }
 447          
 448          
*** WARNING C290 IN LINE 16 OF MAIN.C: missing return value


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2266    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    132      48
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
